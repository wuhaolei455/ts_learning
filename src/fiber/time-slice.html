<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ—¶é—´åˆ‡ç‰‡æ¼”ç¤º - Time Slicing Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      color: white;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .description {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .description h2 {
      color: #667eea;
      margin-bottom: 10px;
    }

    .description p {
      line-height: 1.6;
      margin-bottom: 10px;
    }

    .demo-section {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (min-width: 768px) {
      .demo-section {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (min-width: 1200px) {
      .demo-section {
        grid-template-columns: 1fr 1fr 1fr;
      }
    }

    .demo-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .demo-card h3 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.5em;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    button {
      flex: 1;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
    }

    .btn-start {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .btn-start:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-start:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .btn-stop {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .btn-stop:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(245, 87, 108, 0.4);
    }

    .status {
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
    }

    .status-label {
      font-weight: 600;
      margin-bottom: 5px;
    }

    .status-value {
      font-size: 1.2em;
      color: #667eea;
    }

    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .log-container {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 8px;
      height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }

    .log-line {
      margin-bottom: 5px;
      padding: 3px 0;
    }

    .log-time {
      color: #858585;
      margin-right: 10px;
    }

    .interactive-test {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .interactive-test h3 {
      color: #667eea;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>âš¡ æ—¶é—´åˆ‡ç‰‡æ¼”ç¤º Time Slicing Demo</h1>

    <div class="description">
      <h2>ğŸ“– ä»€ä¹ˆæ˜¯æ—¶é—´åˆ‡ç‰‡ï¼Ÿ</h2>
      <p>
        <strong>æ—¶é—´åˆ‡ç‰‡ï¼ˆTime Slicingï¼‰</strong> æ˜¯ä¸€ç§å°†é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡åˆ†å‰²æˆå¤šä¸ªå°ä»»åŠ¡çš„æŠ€æœ¯ï¼Œ
        æ¯ä¸ªå°ä»»åŠ¡æ‰§è¡Œå®Œåä¼šè®©å‡ºä¸»çº¿ç¨‹ï¼Œè®©æµè§ˆå™¨æœ‰æœºä¼šå¤„ç†ç”¨æˆ·äº¤äº’å’Œæ¸²æŸ“æ›´æ–°ã€‚
      </p>
      <p>
        åœ¨è¿™ä¸ªæ¼”ç¤ºä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†<strong>ä¸‰ç§å®ç°æ–¹å¼</strong>ï¼š
      </p>
      <ul style="margin-left: 20px; line-height: 1.8;">
        <li><strong>setTimeout æ—¶é—´åˆ‡ç‰‡</strong>ï¼šä½¿ç”¨ setTimeout(0) è®©å‡ºä¸»çº¿ç¨‹ï¼Œç®€å•æœ‰æ•ˆ</li>
        <li><strong>é˜»å¡æ‰§è¡Œ</strong>ï¼šä¸ä½¿ç”¨æ—¶é—´åˆ‡ç‰‡ï¼Œé¡µé¢ä¼šå®Œå…¨å¡ä½</li>
        <li><strong>requestIdleCallback + RAF</strong>ï¼šæ™ºèƒ½åˆ©ç”¨æµè§ˆå™¨ç©ºé—²æ—¶é—´ï¼Œä¼˜å…ˆä¿è¯å“åº”æ€§ï¼ˆç±»ä¼¼ React Fiberï¼‰</li>
      </ul>
      <p style="margin-top: 10px;">
        å°è¯•åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥å†…å®¹ï¼Œç„¶åç‚¹å‡»ä¸åŒçš„æ¼”ç¤ºæŒ‰é’®ï¼Œè§‚å¯Ÿé¡µé¢å“åº”æ€§çš„å·®å¼‚ã€‚
      </p>
    </div>

    <div class="interactive-test">
      <h3>ğŸ¯ äº¤äº’æµ‹è¯•åŒºåŸŸ</h3>
      <p style="text-align: center; margin-bottom: 15px;">
        å°è¯•åœ¨ä¸‹é¢çš„è¾“å…¥æ¡†ä¸­è¾“å…¥å†…å®¹ï¼Œæµ‹è¯•é¡µé¢æ˜¯å¦ä¿æŒå“åº”
      </p>
      <input 
        type="text" 
        id="testInput" 
        placeholder="åœ¨è¿™é‡Œè¾“å…¥æ–‡å­—æµ‹è¯•é¡µé¢å“åº”æ€§..." 
        style="width: 100%; padding: 15px; font-size: 16px; border: 2px solid #667eea; border-radius: 8px; outline: none; transition: all 0.3s ease;"
        oninput="this.style.borderColor = '#28a745'; setTimeout(() => this.style.borderColor = '#667eea', 500);"
      />
    </div>

    <div class="demo-section">
      <!-- æœ‰æ—¶é—´åˆ‡ç‰‡ -->
      <div class="demo-card">
        <h3>âœ… ä½¿ç”¨æ—¶é—´åˆ‡ç‰‡</h3>
        <div class="button-group">
          <button class="btn-start" id="startBtn1" onclick="startWithSlicing()">å¼€å§‹æ‰§è¡Œ</button>
          <button class="btn-stop" id="stopBtn1" onclick="stopWithSlicing()" disabled>åœæ­¢</button>
        </div>
        <div class="status">
          <div class="status-label">çŠ¶æ€ï¼š</div>
          <div class="status-value" id="status1">å°±ç»ª</div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress1">0%</div>
        </div>
        <div class="log-container" id="log1">
          <div class="log-line"><span class="log-time">[ç³»ç»Ÿ]</span> å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»"å¼€å§‹æ‰§è¡Œ"å¼€å§‹æ¼”ç¤º</div>
        </div>
      </div>

      <!-- æ— æ—¶é—´åˆ‡ç‰‡ -->
      <div class="demo-card">
        <h3>âŒ ä¸ä½¿ç”¨æ—¶é—´åˆ‡ç‰‡</h3>
        <div class="button-group">
          <button class="btn-start" id="startBtn2" onclick="startWithoutSlicing()">å¼€å§‹æ‰§è¡Œ</button>
          <button class="btn-stop" id="stopBtn2" onclick="stopWithoutSlicing()" disabled>åœæ­¢</button>
        </div>
        <div class="status">
          <div class="status-label">çŠ¶æ€ï¼š</div>
          <div class="status-value" id="status2">å°±ç»ª</div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress2">0%</div>
        </div>
        <div class="log-container" id="log2">
          <div class="log-line"><span class="log-time">[ç³»ç»Ÿ]</span> å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»"å¼€å§‹æ‰§è¡Œ"å¼€å§‹æ¼”ç¤º</div>
        </div>
      </div>

      <!-- requestIdleCallback + RAF -->
      <div class="demo-card">
        <h3>ğŸš€ requestIdleCallback + RAF</h3>
        <div class="button-group">
          <button class="btn-start" id="startBtn3" onclick="startWithIdle()">å¼€å§‹æ‰§è¡Œ</button>
          <button class="btn-stop" id="stopBtn3" onclick="stopWithIdle()" disabled>åœæ­¢</button>
        </div>
        <div class="status">
          <div class="status-label">çŠ¶æ€ï¼š</div>
          <div class="status-value" id="status3">å°±ç»ª</div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress3">0%</div>
        </div>
        <div class="log-container" id="log3">
          <div class="log-line"><span class="log-time">[ç³»ç»Ÿ]</span> å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»"å¼€å§‹æ‰§è¡Œ"å¼€å§‹æ¼”ç¤º</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== time-slice.js æ ¸å¿ƒä»£ç  ==========
    function doHeavyWork(index) {
      const start = performance.now();
      while (performance.now() - start < 5) {
        // do nothing, just wait
      }
      console.log(`Doing heavy work: ${index}`);
    }

    // ========== UI æ§åˆ¶å˜é‡ ==========
    let stopFlag1 = false;
    let stopFlag2 = false;

    function addLog(containerId, message) {
      const logContainer = document.getElementById(containerId);
      const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
      const logLine = document.createElement('div');
      logLine.className = 'log-line';
      logLine.innerHTML = `<span class="log-time">[${time}]</span> ${message}`;
      logContainer.appendChild(logLine);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function updateProgress(progressId, current, total) {
      const progress = Math.round((current / total) * 100);
      const progressFill = document.getElementById(progressId);
      progressFill.style.width = progress + '%';
      progressFill.textContent = progress + '%';
    }

    function updateStatus(statusId, text) {
      document.getElementById(statusId).textContent = text;
    }

    // ä½¿ç”¨æ—¶é—´åˆ‡ç‰‡
    async function startWithSlicing() {
      stopFlag1 = false;
      document.getElementById('startBtn1').disabled = true;
      document.getElementById('stopBtn1').disabled = false;
      document.getElementById('log1').innerHTML = '';
      
      addLog('log1', 'å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼ˆä½¿ç”¨æ—¶é—´åˆ‡ç‰‡ï¼‰');
      updateStatus('status1', 'æ‰§è¡Œä¸­...');
      
      const totalTasks = 1000;
      const sliceSize = 50;
      
      // ä½¿ç”¨æ—¶é—´åˆ‡ç‰‡æ‰§è¡Œä»»åŠ¡
      for (let i = 0; i < totalTasks && !stopFlag1; i += sliceSize) {
        for (let j = i; j < i + sliceSize && j < totalTasks && !stopFlag1; j++) {
          doHeavyWork(j);
        }
        updateProgress('progress1', Math.min(i + sliceSize, totalTasks), totalTasks);
        if (i % 100 === 0) {
          addLog('log1', `æ­£åœ¨å¤„ç†ä»»åŠ¡ ${Math.min(i + sliceSize, totalTasks)}/${totalTasks}`);
        }
        await new Promise(resolve => setTimeout(resolve, 0)); // è®©å‡ºä¸»çº¿ç¨‹
      }
      
      if (!stopFlag1) {
        addLog('log1', 'âœ… æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼');
        updateStatus('status1', 'å·²å®Œæˆ');
      } else {
        addLog('log1', 'âš ï¸ ä»»åŠ¡å·²åœæ­¢');
        updateStatus('status1', 'å·²åœæ­¢');
      }
      
      document.getElementById('startBtn1').disabled = false;
      document.getElementById('stopBtn1').disabled = true;
    }

    function stopWithSlicing() {
      stopFlag1 = true;
    }

    // ä¸ä½¿ç”¨æ—¶é—´åˆ‡ç‰‡
    async function startWithoutSlicing() {
      stopFlag2 = false;
      document.getElementById('startBtn2').disabled = true;
      document.getElementById('stopBtn2').disabled = false;
      document.getElementById('log2').innerHTML = '';
      
      addLog('log2', 'âš ï¸ å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼ˆä¸ä½¿ç”¨æ—¶é—´åˆ‡ç‰‡ - é¡µé¢å°†å¡ä½ï¼‰');
      updateStatus('status2', 'æ‰§è¡Œä¸­...');
      
      // ä½¿ç”¨ setTimeout è®©æ—¥å¿—æœ‰æœºä¼šæ˜¾ç¤º
      await new Promise(resolve => setTimeout(resolve, 100));
      
      const totalTasks = 1000;
      const startTime = performance.now();
      
      // ä¸ä½¿ç”¨æ—¶é—´åˆ‡ç‰‡ï¼Œä¸€æ¬¡æ€§æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡
      for (let i = 0; i < totalTasks && !stopFlag2; i++) {
        doHeavyWork(i);
        // æ³¨æ„ï¼šè¿™é‡Œæ›´æ–°è¿›åº¦æ¡ï¼Œä½†ç”±äºä¸»çº¿ç¨‹è¢«å ç”¨ï¼ŒUI ä¸ä¼šå®æ—¶æ›´æ–°
        if (i % 100 === 0) {
          updateProgress('progress2', i, totalTasks);
        }
      }
      
      const endTime = performance.now();
      
      if (!stopFlag2) {
        updateProgress('progress2', totalTasks, totalTasks);
        addLog('log2', `âœ… æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼è€—æ—¶ï¼š${(endTime - startTime).toFixed(2)}ms`);
        addLog('log2', 'æ³¨æ„ï¼šåœ¨ä»»åŠ¡æ‰§è¡ŒæœŸé—´ï¼Œé¡µé¢å®Œå…¨æ— å“åº”');
        updateStatus('status2', 'å·²å®Œæˆ');
      } else {
        addLog('log2', 'âš ï¸ ä»»åŠ¡å·²åœæ­¢');
        updateStatus('status2', 'å·²åœæ­¢');
      }
      
      document.getElementById('startBtn2').disabled = false;
      document.getElementById('stopBtn2').disabled = true;
    }

    function stopWithoutSlicing() {
      stopFlag2 = true;
    }

    // ========== requestIdleCallback + RAF å®ç° ==========
    let stopFlag3 = false;

    /**
     * ä½¿ç”¨ requestIdleCallback + requestAnimationFrame å®ç°çš„æ—¶é—´åˆ‡ç‰‡
     */
    async function timeSlicedWorkWithIdle(tasks = [], onProgress = null, shouldStop = () => false) {
      // requestIdleCallback çš„ polyfillï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰
      const requestIdleCallbackPolyfill = window.requestIdleCallback || function(callback) {
        const start = Date.now();
        return setTimeout(() => {
          callback({
            didTimeout: false,
            timeRemaining: () => Math.max(0, 50 - (Date.now() - start))
          });
        }, 1);
      };

      return new Promise((resolve) => {
        let currentIndex = 0;
        const totalTasks = tasks.length;

        function processTask(deadline) {
          // å½“è¿˜æœ‰å‰©ä½™æ—¶é—´ä¸”æœ‰ä»»åŠ¡æ—¶ï¼Œç»§ç»­æ‰§è¡Œ
          while ((deadline.timeRemaining() > 0 || deadline.didTimeout) && currentIndex < totalTasks) {
            if (shouldStop()) {
              resolve({ completed: false, processed: currentIndex });
              return;
            }

            // æ‰§è¡Œä»»åŠ¡
            tasks[currentIndex]();
            currentIndex++;

            // è¿›åº¦å›è°ƒ
            if (onProgress) {
              onProgress(currentIndex, totalTasks);
            }

            // å¦‚æœæ‰€æœ‰ä»»åŠ¡å®Œæˆ
            if (currentIndex >= totalTasks) {
              resolve({ completed: true, processed: currentIndex });
              return;
            }
          }

          // å¦‚æœè¿˜æœ‰ä»»åŠ¡ï¼Œç»§ç»­è°ƒåº¦
          if (currentIndex < totalTasks) {
            // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿åœ¨ä¸‹ä¸€å¸§ä¹‹å‰æ›´æ–°
            requestAnimationFrame(() => {
              // åœ¨ä¸‹ä¸€å¸§ä¸­ä½¿ç”¨ requestIdleCallback ç»§ç»­æ‰§è¡Œ
              requestIdleCallbackPolyfill(processTask);
            });
          }
        }

        // å¼€å§‹å¤„ç†
        requestIdleCallbackPolyfill(processTask);
      });
    }

    // ä½¿ç”¨ requestIdleCallback + RAF
    async function startWithIdle() {
      stopFlag3 = false;
      document.getElementById('startBtn3').disabled = true;
      document.getElementById('stopBtn3').disabled = false;
      document.getElementById('log3').innerHTML = '';
      
      addLog('log3', 'å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼ˆä½¿ç”¨ requestIdleCallback + RAFï¼‰');
      addLog('log3', 'ğŸ’¡ åˆ©ç”¨æµè§ˆå™¨ç©ºé—²æ—¶é—´æ‰§è¡Œä»»åŠ¡');
      updateStatus('status3', 'æ‰§è¡Œä¸­...');
      
      const totalTasks = 1000;
      const startTime = performance.now();
      
      // åˆ›å»ºä»»åŠ¡æ•°ç»„
      const tasks = [];
      for (let i = 0; i < totalTasks; i++) {
        tasks.push(() => doHeavyWork(i));
      }
      
      // ä½¿ç”¨ requestIdleCallback + RAF æ‰§è¡Œ
      const result = await timeSlicedWorkWithIdle(
        tasks,
        (current, total) => {
          updateProgress('progress3', current, total);
          if (current % 100 === 0 || current === total) {
            addLog('log3', `æ­£åœ¨å¤„ç†ä»»åŠ¡ ${current}/${total}`);
          }
        },
        () => stopFlag3
      );
      
      const endTime = performance.now();
      
      if (result.completed) {
        addLog('log3', `âœ… æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼è€—æ—¶ï¼š${(endTime - startTime).toFixed(2)}ms`);
        addLog('log3', 'ç‰¹ç‚¹ï¼šåœ¨æµè§ˆå™¨ç©ºé—²æ—¶æ‰§è¡Œï¼Œä¼˜å…ˆä¿è¯å“åº”æ€§');
        updateStatus('status3', 'å·²å®Œæˆ');
      } else {
        addLog('log3', 'âš ï¸ ä»»åŠ¡å·²åœæ­¢');
        updateStatus('status3', 'å·²åœæ­¢');
      }
      
      document.getElementById('startBtn3').disabled = false;
      document.getElementById('stopBtn3').disabled = true;
    }

    function stopWithIdle() {
      stopFlag3 = true;
    }

    // é¡µé¢åŠ è½½å®Œæˆæç¤º
    window.addEventListener('load', () => {
      console.log('âœ… æ—¶é—´åˆ‡ç‰‡æ¼”ç¤ºé¡µé¢åŠ è½½å®Œæˆ');
      console.log('ğŸ“¦ åŒ…å«ä¸‰ç§å®ç°æ–¹å¼ï¼šsetTimeoutã€é˜»å¡ã€requestIdleCallback + RAF');
    });
  </script>
</body>
</html>

