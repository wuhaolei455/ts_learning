<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åœ¨çº¿å®¢æœç³»ç»Ÿ - é•¿è½®è¯¢Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f0f2f5;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .chat-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 500px;
      height: 700px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .chat-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .header-text h2 {
      font-size: 18px;
      margin-bottom: 3px;
    }

    .status {
      font-size: 12px;
      opacity: 0.9;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #48bb78;
      animation: pulse-dot 2s infinite;
    }

    @keyframes pulse-dot {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    .connection-status {
      font-size: 12px;
      padding: 5px 12px;
      border-radius: 15px;
      background: rgba(255,255,255,0.2);
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #f8f9fa;
    }

    .message {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #667eea;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .message.user .message-avatar {
      background: #48bb78;
    }

    .message-content {
      max-width: 70%;
    }

    .message-bubble {
      padding: 12px 16px;
      border-radius: 18px;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      word-wrap: break-word;
    }

    .message.user .message-bubble {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .message-time {
      font-size: 11px;
      color: #999;
      margin-top: 5px;
      padding: 0 8px;
    }

    .typing-indicator {
      display: none;
      padding: 12px 16px;
      background: white;
      border-radius: 18px;
      width: fit-content;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .typing-indicator.active {
      display: block;
    }

    .typing-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #999;
      margin: 0 2px;
      animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.7;
      }
      30% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }

    .chat-input {
      padding: 20px;
      background: white;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 10px;
    }

    .input-field {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 25px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.3s;
    }

    .input-field:focus {
      border-color: #667eea;
    }

    .send-btn {
      width: 50px;
      height: 50px;
      border: none;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 20px;
      cursor: pointer;
      transition: transform 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .send-btn:hover {
      transform: scale(1.05);
    }

    .send-btn:active {
      transform: scale(0.95);
    }

    .quick-replies {
      padding: 10px 20px;
      background: white;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 8px;
      overflow-x: auto;
    }

    .quick-reply-btn {
      padding: 8px 16px;
      border: 1px solid #667eea;
      border-radius: 20px;
      background: white;
      color: #667eea;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.3s;
    }

    .quick-reply-btn:hover {
      background: #667eea;
      color: white;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <div class="header-info">
        <div class="avatar">ğŸ‘¨â€ğŸ’¼</div>
        <div class="header-text">
          <h2>å®¢æœå°æ™º</h2>
          <div class="status">
            <span class="status-dot"></span>
            <span>åœ¨çº¿</span>
          </div>
        </div>
      </div>
      <div class="connection-status" id="connectionStatus">é•¿è½®è¯¢ä¸­</div>
    </div>

    <div class="chat-messages" id="chatMessages">
      <div class="message">
        <div class="message-avatar">ğŸ‘¨â€ğŸ’¼</div>
        <div class="message-content">
          <div class="message-bubble">
            æ‚¨å¥½ï¼æˆ‘æ˜¯å®¢æœå°æ™ºï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ
          </div>
          <div class="message-time"></div>
        </div>
      </div>
      <div class="message" style="display: flex; gap: 10px;">
        <div class="message-avatar">ğŸ‘¨â€ğŸ’¼</div>
        <div class="typing-indicator" id="typingIndicator">
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
        </div>
      </div>
    </div>

    <div class="quick-replies">
      <button class="quick-reply-btn" onclick="sendQuickReply('æŸ¥è¯¢è®¢å•')">ğŸ“¦ æŸ¥è¯¢è®¢å•</button>
      <button class="quick-reply-btn" onclick="sendQuickReply('é€€æ¬¾é—®é¢˜')">ğŸ’° é€€æ¬¾é—®é¢˜</button>
      <button class="quick-reply-btn" onclick="sendQuickReply('ç‰©æµæŸ¥è¯¢')">ğŸšš ç‰©æµæŸ¥è¯¢</button>
      <button class="quick-reply-btn" onclick="sendQuickReply('å•†å“å’¨è¯¢')">ğŸ›ï¸ å•†å“å’¨è¯¢</button>
    </div>

    <div class="chat-input">
      <input 
        type="text" 
        class="input-field" 
        id="messageInput" 
        placeholder="è¾“å…¥æ¶ˆæ¯..."
        onkeypress="handleKeyPress(event)"
      >
      <button class="send-btn" onclick="sendMessage()">ğŸ“¤</button>
    </div>
  </div>

  <script>
    // ===== æ¨¡æ‹Ÿå®¢æœåç«¯ =====
    class CustomerServiceServer {
      constructor() {
        this.messageQueue = [];
        this.autoReplyTemplates = {
          'æŸ¥è¯¢è®¢å•': 'å¥½çš„ï¼Œè¯·æä¾›æ‚¨çš„è®¢å•å·ï¼Œæˆ‘å¸®æ‚¨æŸ¥è¯¢è®¢å•çŠ¶æ€ã€‚',
          'é€€æ¬¾é—®é¢˜': 'å…³äºé€€æ¬¾ï¼Œè¯·é—®æ‚¨æ˜¯è¦ç”³è¯·é€€æ¬¾è¿˜æ˜¯æŸ¥è¯¢é€€æ¬¾è¿›åº¦å‘¢ï¼Ÿ',
          'ç‰©æµæŸ¥è¯¢': 'å¥½çš„ï¼Œè¯·æä¾›è®¢å•å·ï¼Œæˆ‘å¸®æ‚¨æŸ¥è¯¢ç‰©æµä¿¡æ¯ã€‚',
          'å•†å“å’¨è¯¢': 'è¯·é—®æ‚¨æƒ³å’¨è¯¢å“ªä¸ªå•†å“å‘¢ï¼Ÿå¯ä»¥æä¾›å•†å“åç§°æˆ–é“¾æ¥ã€‚',
          'default': [
            'æˆ‘ç†è§£æ‚¨çš„é—®é¢˜äº†ï¼Œè®©æˆ‘ä¸ºæ‚¨å¤„ç†...',
            'å¥½çš„ï¼Œæˆ‘é©¬ä¸Šä¸ºæ‚¨æŸ¥è¯¢ç›¸å…³ä¿¡æ¯ã€‚',
            'æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼Œæˆ‘ä¼šå°½å¿«å¸®æ‚¨è§£å†³ã€‚',
            'æ”¶åˆ°ï¼æ­£åœ¨ä¸ºæ‚¨æ ¸å®ä¿¡æ¯...'
          ]
        };
      }

      // æ¨¡æ‹Ÿæ¥æ”¶ç”¨æˆ·æ¶ˆæ¯å¹¶è‡ªåŠ¨å›å¤
      receiveMessage(userMessage) {
        // æ¨¡æ‹Ÿæ€è€ƒæ—¶é—´
        setTimeout(() => {
          const reply = this.generateReply(userMessage);
          this.messageQueue.push({
            id: Date.now(),
            text: reply,
            time: new Date().toLocaleTimeString(),
            from: 'service'
          });
        }, Math.random() * 2000 + 1000); // 1-3ç§’éšæœºå»¶è¿Ÿ
      }

      generateReply(userMessage) {
        // æ£€æŸ¥æ˜¯å¦æœ‰é¢„è®¾å›å¤
        if (this.autoReplyTemplates[userMessage]) {
          return this.autoReplyTemplates[userMessage];
        }

        // éšæœºè¿”å›é»˜è®¤å›å¤
        const defaultReplies = this.autoReplyTemplates.default;
        return defaultReplies[Math.floor(Math.random() * defaultReplies.length)];
      }

      // é•¿è½®è¯¢æ¥å£ï¼šç­‰å¾…æ–°æ¶ˆæ¯
      async pollNewMessages(lastMessageId) {
        return new Promise((resolve) => {
          const checkInterval = setInterval(() => {
            // æŸ¥æ‰¾æ–°æ¶ˆæ¯
            const newMessages = this.messageQueue.filter(msg => msg.id > lastMessageId);
            
            if (newMessages.length > 0) {
              clearInterval(checkInterval);
              resolve({
                hasUpdate: true,
                messages: newMessages
              });
            }
          }, 500);

          // 30ç§’è¶…æ—¶
          setTimeout(() => {
            clearInterval(checkInterval);
            resolve({
              hasUpdate: false,
              messages: []
            });
          }, 30000);
        });
      }

      // æ¨¡æ‹Ÿéšæœºå‘é€å®¢æœä¸»åŠ¨æ¶ˆæ¯ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
      startRandomMessages() {
        const proactiveMessages = [
          'å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜ï¼Œéšæ—¶å¯ä»¥é—®æˆ‘å“¦ï¼',
          'æˆ‘ä»¬æœ€è¿‘æ¨å‡ºäº†æ–°çš„ä¼˜æƒ æ´»åŠ¨ï¼Œéœ€è¦äº†è§£å—ï¼Ÿ',
          'æ‚¨çš„é—®é¢˜è§£å†³äº†å—ï¼Ÿè¿˜æœ‰ä»€ä¹ˆéœ€è¦å¸®åŠ©çš„å—ï¼Ÿ'
        ];

        setInterval(() => {
          if (Math.random() < 0.1) { // 10%æ¦‚ç‡å‘é€ä¸»åŠ¨æ¶ˆæ¯
            this.messageQueue.push({
              id: Date.now(),
              text: proactiveMessages[Math.floor(Math.random() * proactiveMessages.length)],
              time: new Date().toLocaleTimeString(),
              from: 'service'
            });
          }
        }, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
      }
    }

    // ===== å‰ç«¯å®¢æˆ·ç«¯ =====
    class ChatClient {
      constructor() {
        this.server = new CustomerServiceServer();
        this.lastMessageId = 0;
        this.isPolling = false;
        
        this.initUI();
        this.startLongPolling();
        
        // å¯é€‰ï¼šå¯åŠ¨æœåŠ¡å™¨éšæœºæ¶ˆæ¯
        // this.server.startRandomMessages();
      }

      initUI() {
        const messages = document.querySelectorAll('.message-time');
        messages.forEach(el => {
          el.textContent = new Date().toLocaleTimeString();
        });
      }

      async startLongPolling() {
        this.isPolling = true;
        
        while (this.isPolling) {
          try {
            console.log('[é•¿è½®è¯¢] ç­‰å¾…æ–°æ¶ˆæ¯...', new Date().toLocaleTimeString());
            this.updateConnectionStatus('ç­‰å¾…ä¸­...');
            
            // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // è°ƒç”¨é•¿è½®è¯¢æ¥å£
            const response = await this.server.pollNewMessages(this.lastMessageId);
            
            if (response.hasUpdate && response.messages.length > 0) {
              console.log('[é•¿è½®è¯¢] æ”¶åˆ°æ–°æ¶ˆæ¯:', response.messages);
              this.updateConnectionStatus('å·²è¿æ¥ âœ“');
              
              for (const message of response.messages) {
                await this.displayServiceMessage(message.text, message.time);
                this.lastMessageId = Math.max(this.lastMessageId, message.id);
              }
            } else {
              console.log('[é•¿è½®è¯¢] è¶…æ—¶ï¼Œé‡æ–°è¿æ¥...');
              this.updateConnectionStatus('é‡è¿ä¸­...');
            }
          } catch (error) {
            console.error('[é•¿è½®è¯¢] é”™è¯¯:', error);
            this.updateConnectionStatus('è¿æ¥å¤±è´¥');
            await new Promise(resolve => setTimeout(resolve, 2000));
          }
        }
      }

      async displayServiceMessage(text, time) {
        // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
        const typingIndicator = document.getElementById('typingIndicator');
        typingIndicator.classList.add('active');
        
        // æ¨¡æ‹Ÿæ‰“å­—å»¶è¿Ÿ
        await new Promise(resolve => setTimeout(resolve, 800));
        
        typingIndicator.classList.remove('active');
        
        // æ·»åŠ æ¶ˆæ¯
        this.addMessage(text, 'service', time);
      }

      addMessage(text, from, time) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${from === 'user' ? 'user' : ''}`;
        
        const avatar = from === 'user' ? 'ğŸ‘¤' : 'ğŸ‘¨â€ğŸ’¼';
        time = time || new Date().toLocaleTimeString();
        
        messageDiv.innerHTML = `
          <div class="message-avatar">${avatar}</div>
          <div class="message-content">
            <div class="message-bubble">${text}</div>
            <div class="message-time">${time}</div>
          </div>
        `;
        
        // åœ¨è¾“å…¥æŒ‡ç¤ºå™¨ä¹‹å‰æ’å…¥
        const typingIndicatorParent = document.getElementById('typingIndicator').parentElement;
        messagesContainer.insertBefore(messageDiv, typingIndicatorParent);
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      sendMessage(text) {
        if (!text || !text.trim()) return;
        
        // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        this.addMessage(text, 'user');
        
        // å‘é€åˆ°æœåŠ¡å™¨
        this.server.receiveMessage(text);
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('messageInput').value = '';
      }

      updateConnectionStatus(status) {
        document.getElementById('connectionStatus').textContent = status;
      }
    }

    // å…¨å±€å‡½æ•°
    let chatClient;

    function sendMessage() {
      const input = document.getElementById('messageInput');
      chatClient.sendMessage(input.value);
    }

    function sendQuickReply(text) {
      chatClient.sendMessage(text);
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    // åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      chatClient = new ChatClient();
    });
  </script>
</body>
</html>

